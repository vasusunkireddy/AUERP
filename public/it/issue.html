<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IT Department - Issues</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: url("https://i.postimg.cc/K81T8GL4/au-back2.jpg") no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 32px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
    }
    header h1 { font-size: 22px; margin: 0; font-weight: 700; }
    .back-btn, .logout-btn {
      padding: 10px 18px;
      background: linear-gradient(135deg, #2563eb, #1e40af);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .container { padding: 32px; max-width: 1100px; margin: auto; }
    h2 { margin-bottom: 20px; font-size: 26px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(12px);
    }
    th, td {
      padding: 14px;
      text-align: left;
      font-size: 14px;
      color: #fff;
    }
    th { background: rgba(37, 99, 235, 0.9); font-weight: 600; }
    tr:nth-child(even) { background: rgba(255,255,255,0.05); }
    button.action-btn {
      padding: 8px 14px;
      background: linear-gradient(135deg, #16a34a, #15803d);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    button.action-btn:hover {
      background: linear-gradient(135deg, #15803d, #166534);
    }
    .toast {
      visibility: hidden;
      min-width: 320px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 16px;
      position: fixed;
      z-index: 1000;
      left: 50%;
      top: 20px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transform: translateX(-50%);
      transition: opacity 0.4s ease, top 0.4s ease;
    }
    .toast.show { visibility: visible; opacity: 1; top: 30px; }
  </style>
</head>
<body>
  <header>
    <h1>IT Department - Issues</h1>
    <div>
      <button class="back-btn" onclick="window.location.href='/it/dashboard.html'">Back</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="container">
    <h2>Reported Issues (Device Reset Needed)</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Reg No</th>
          <th>Name</th>
          <th>Email</th>
          <th>Issue</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="issuesTable">
        <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const toast = document.getElementById('toast');
    const tableBody = document.getElementById("issuesTable");

    function showToast(message, isError=false) {
      toast.innerText = message;
      toast.style.background = isError
        ? 'rgba(220,38,38,0.9)'
        : 'rgba(34,197,94,0.9)';
      toast.className = 'toast show';
      setTimeout(() => { toast.className = 'toast'; }, 3000);
    }

    async function fetchIssues() {
      try {
        const res = await fetch("/api/it/students/issues");
        const data = await res.json();
        if (data.success) {
          tableBody.innerHTML = "";
          if (data.issues.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No issues found âœ…</td></tr>`;
          } else {
            data.issues.forEach(s => {
              tableBody.innerHTML += `
                <tr>
                  <td>${s.id}</td>
                  <td>${s.registration_no}</td>
                  <td>${s.name}</td>
                  <td>${s.email}</td>
                  <td>${s.issue || "Device reset requested"}</td>
                  <td>
                    <button class="action-btn" onclick="resetDevice(${s.id})">
                      Reset Device
                    </button>
                  </td>
                </tr>`;
            });
          }
        } else {
          showToast("Failed to load issues", true);
        }
      } catch (err) {
        console.error("Error fetching issues:", err);
        showToast("Server error while loading issues", true);
      }
    }

    async function resetDevice(id) {
      try {
        const res = await fetch("/api/it/students/reset-device", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ studentId: id })
        });
        const data = await res.json();
        if (data.success) {
          showToast("Device reset successful!");
          fetchIssues();
        } else {
          showToast(data.message || "Failed to reset device", true);
        }
      } catch (err) {
        console.error("Reset error:", err);
        showToast("Server error while resetting device", true);
      }
    }

    function logout() {
      localStorage.removeItem("it_admin");
      showToast("Logged out successfully");
      setTimeout(() => {
        window.location.href = "/it/login.html";
      }, 1500);
    }

    fetchIssues();
  </script>
</body>
</html>
