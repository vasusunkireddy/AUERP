<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Timetable - Dean Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <style>
    :root { --primary:#1e293b; --accent:#2563eb; --bg:#f9fafb; --border:#e5e7eb; --text:#1f2937; --danger:#dc2626; --success:#16a34a; }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}
    body{display:flex;min-height:100vh;background:var(--bg);color:var(--text)}
    .sidebar{width:250px;background:linear-gradient(180deg,#1e293b,#111827);color:#fff;height:100vh;position:fixed;display:flex;flex-direction:column}
    .sidebar-header{background:#2563eb;padding:18px;text-align:center;font-size:18px;font-weight:700}
    .sidebar ul{list-style:none;margin-top:20px;padding:0 10px;flex-grow:1}
    .sidebar li{margin:6px 0}
    .sidebar li a{display:flex;align-items:center;padding:12px 14px;text-decoration:none;color:#d1d5db;font-size:14px;border-radius:8px;transition:all .3s ease}
    .sidebar li a i{width:22px;margin-right:10px}
    .sidebar li a:hover{background:rgba(37,99,235,.15);color:#fff}
    .sidebar li.active a{background:#2563eb;color:#fff;font-weight:600}
    .main-content{margin-left:250px;padding:24px;width:calc(100% - 250px);display:flex;flex-direction:column;min-height:100vh}
    .topbar{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:14px 18px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin-bottom:24px}
    .topbar-left{display:flex;align-items:center;gap:12px}
    .topbar-left img{height:40px}
    .topbar h1{font-size:20px;font-weight:600;color:var(--primary)}
    .section{background:#fff;padding:22px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);flex-grow:1}
    .section h2{font-size:18px;font-weight:600;margin-bottom:18px}
    form{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
    select,input{padding:10px;border:1px solid var(--border);border-radius:6px;font-size:14px;flex:1}
    button{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-size:14px}
    button:hover{background:#1e40af}
    button[disabled]{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:20px;text-align:center}
    th,td{border:1px solid var(--border);padding:12px;font-size:14px;vertical-align:middle}
    th{background:#f3f4f6;font-size:15px}
    td{font-size:13px}
    td .action-btn{margin:3px;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;font-size:12px}
    .edit-btn{background:#2563eb;color:#fff}
    .delete-btn{background:#dc2626;color:#fff}
    .holiday{background:#fee2e2;color:#dc2626;font-weight:700}
    .toast-container{position:fixed;top:20px;right:20px;z-index:9999}
    .toast{background:#fff;border-left:6px solid;padding:12px 18px;margin-top:10px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.15);min-width:240px;font-size:14px;animation:slideIn .3s ease}
    .toast.success{border-color:var(--success)}
    .toast.error{border-color:var(--danger)}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#fff;padding:20px;border-radius:8px;width:500px;max-width:95%}
    .modal-content h3{margin-bottom:15px}
    .modal-content form{display:flex;flex-direction:column;gap:12px}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">AU ERP</div>
    <ul>
      <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
      <li><a href="department.html"><i class="fas fa-building"></i> Departments</a></li>
      <li><a href="sections.html"><i class="fas fa-users"></i> Sections</a></li>
      <li><a href="faculty.html"><i class="fas fa-chalkboard-teacher"></i> Faculty</a></li>
      <li><a href="students.html"><i class="fas fa-user-graduate"></i> Students</a></li>
      <li><a href="courses.html"><i class="fas fa-book"></i> Courses</a></li>
      <li class="active"><a href="timetable.html"><i class="fas fa-calendar-alt"></i> Timetable</a></li>
      <li><a href="holidays.html"><i class="fas fa-umbrella-beach"></i> Holidays</a></li>
      <li><a href="attendance.html"><i class="fas fa-check-circle"></i> Attendance</a></li>
      <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </div>

  <!-- Main -->
  <div class="main-content">
    <div class="topbar">
      <div class="topbar-left">
        <img src="https://i.postimg.cc/cHN88t2D/AU.png" alt="AU Logo">
        <h1>Timetable Management</h1>
      </div>
    </div>

    <div class="section">
      <h2>Create Timetable Entry</h2>
      <form id="timetableForm" autocomplete="off">
        <select id="section" required></select>
        <select id="course" required></select>
        <select id="faculty" required></select>
        <select id="timeslot" required></select>
        <input type="text" id="room" placeholder="Room No." required />
        <button id="addBtn" type="submit">Add</button>
      </form>

      <h2>Section Timetable</h2>
      <select id="sectionView"></select>
      <div id="sectionInfo" style="margin:10px 0;font-weight:600;color:#2563eb;"></div>
      <table id="timetableGrid">
        <thead>
          <tr id="dayHeader">
            <th>Session / Time</th>
            <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
          </tr>
        </thead>
        <tbody id="timetableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>Edit Timetable Entry</h3>
      <form id="editForm">
        <input type="hidden" id="editId">
        <select id="editCourse" required></select>
        <select id="editFaculty" required></select>
        <select id="editTimeslot" required></select>
        <input type="text" id="editRoom" placeholder="Room No." required>
        <button type="submit">Update</button>
      </form>
    </div>
  </div>

  <script>
    const API = "http://localhost:3000/api/dean";

    const toastContainer = document.getElementById("toastContainer");
    function showToast(message, type="success") {
      const toast = document.createElement("div");
      toast.className = "toast " + type;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }

    let courses = [], faculty = [], timeslots = [], holidays = [];

    // --- Date helpers (use the current week) ---
    const DAYS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    function startOfWeek(date = new Date()) {
      const d = new Date(date);
      const day = d.getDay(); // 0=Sun..6=Sat
      // Align week to Monday..Saturday as your table shows
      const diffToMonday = (day === 0 ? -6 : 1 - day);
      d.setDate(d.getDate() + diffToMonday);
      d.setHours(0,0,0,0);
      return d; // Monday
    }
    function dateForDayName(dayName) {
      const monday = startOfWeek();
      const idx = ["Mon","Tue","Wed","Thu","Fri","Sat"].indexOf(dayName);
      const target = new Date(monday);
      target.setDate(monday.getDate() + idx);
      target.setHours(0,0,0,0);
      return target;
    }
    function fmtDate(d) {
      return d.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});
    }
    function sameDate(d1, d2) {
      return d1.getFullYear()===d2.getFullYear() && d1.getMonth()===d2.getMonth() && d1.getDate()===d2.getDate();
    }

    async function loadDropdowns() {
      // Sections
      const secRes = await fetch(`${API}/sections`);
      const sections = await secRes.json();
      const secSelect = document.getElementById("section");
      const secView = document.getElementById("sectionView");
      secSelect.innerHTML = secView.innerHTML = "<option value=''>Select Section</option>";
      sections.forEach(s => {
        const label = `${s.program_name} - ${s.department_name} - Section ${s.section_name} (Batch ${s.batch_name}, Sem ${s.semester})`;
        const opt = `<option value="${s.id}">${label}</option>`;
        secSelect.insertAdjacentHTML("beforeend", opt);
        secView.insertAdjacentHTML("beforeend", opt);
      });

      // Courses
      const cRes = await fetch(`${API}/courses`);
      courses = await cRes.json();
      const cSelect = document.getElementById("course");
      cSelect.innerHTML = "<option value=''>Select Course</option>";
      courses.forEach(c => cSelect.insertAdjacentHTML("beforeend", `<option value="${c.id}">${c.code} - ${c.name}</option>`));

      // Faculty
      const fRes = await fetch(`${API}/faculty`);
      faculty = await fRes.json();
      const fSelect = document.getElementById("faculty");
      fSelect.innerHTML = "<option value=''>Select Faculty</option>";
      faculty.forEach(f => fSelect.insertAdjacentHTML("beforeend", `<option value="${f.id}">${f.name}</option>`));

      // Timeslots
      const tRes = await fetch(`${API}/timeslots`);
      timeslots = await tRes.json();
      const tSelect = document.getElementById("timeslot");
      tSelect.innerHTML = "<option value=''>Select Timeslot</option>";
      timeslots.forEach(t => tSelect.insertAdjacentHTML("beforeend", `<option value="${t.id}">${t.day} S${t.session} (${t.start_time}-${t.end_time})</option>`));

      // Holidays
      const hRes = await fetch(`${API}/holidays`);
      holidays = await hRes.json();

      // Load a section view if present
      document.getElementById("sectionView").addEventListener("change", loadTimetable);
      // Default to the first real section for viewing
      const firstSection = sections?.[0]?.id;
      if (firstSection) {
        document.getElementById("sectionView").value = firstSection;
        await loadTimetable();
      }
    }

    async function loadTimetable() {
      const sectionId = document.getElementById("sectionView").value;
      if (!sectionId) return;
      const res = await fetch(`${API}/timetable/${sectionId}`);
      const data = await res.json();
      const timetable = data.timetable || [];
      if (data.holidays) holidays = data.holidays;

      if (timetable.length > 0) {
        const info = timetable[0];
        document.getElementById("sectionInfo").textContent =
          `${info.program_name} - ${info.department_name} - Section ${info.section_name} (Batch ${info.batch_name}, Sem ${info.semester})`;
      } else {
        document.getElementById("sectionInfo").textContent = "";
      }

      const days = ["Mon","Tue","Wed","Thu","Fri","Sat"];
      const sessions = [...new Set(timeslots.map(t => t.session))].sort((a,b)=>a-b);
      const tbody = document.getElementById("timetableBody");
      tbody.innerHTML = "";

      // Header with current week dates
      const headerRow = document.getElementById("dayHeader");
      headerRow.innerHTML = `<th>Session / Time</th>`;
      days.forEach(day => {
        const d = dateForDayName(day);
        headerRow.insertAdjacentHTML("beforeend", `<th>${day}<br><span style="font-size:12px;color:#555;">${fmtDate(d)}</span></th>`);
      });

      sessions.forEach(s => {
        // Assume consistent timing across days for given session
        const monSlot = timeslots.find(t => t.session == s && t.day === "Mon");
        const timeLabel = monSlot ? `${monSlot.start_time} - ${monSlot.end_time}` : "";
        let row = `<tr><td><b>Session ${s}</b><br><span style="font-size:12px;color:#555;">${timeLabel}</span></td>`;
        days.forEach(day => {
          const colDate = dateForDayName(day);
          const holidayToday = holidays.find(h => sameDate(new Date(h.date), colDate));
          const slot = timetable.find(d => d.day===day && Number(d.session)===Number(s));
          if (holidayToday) {
            row += `<td class="holiday">${holidayToday.reason}</td>`;
          } else if (slot) {
            const roomSafe = encodeURIComponent(slot.room || "");
            row += `<td>
                      <b>${slot.course_code}</b><br>
                      ${slot.course_name}<br>
                      <i>${slot.faculty_name}</i><br>
                      Room: ${slot.room || "N/A"}<br>
                      <button class="action-btn edit-btn"
                        onclick="openEdit(${slot.id}, ${slot.course_id}, ${slot.faculty_id}, ${slot.timeslot_id}, '${roomSafe}')">Edit</button>
                      <button class="action-btn delete-btn" onclick="deleteEntry(${slot.id})">Delete</button>
                    </td>`;
          } else {
            row += "<td>-</td>";
          }
        });
        row += "</tr>";
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    // --- Add handler (the missing piece) ---
    document.getElementById("timetableForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = document.getElementById("addBtn");
      btn.disabled = true;

      const section_id = document.getElementById("section").value.trim();
      const course_id  = document.getElementById("course").value.trim();
      const faculty_id = document.getElementById("faculty").value.trim();
      const timeslot_id= document.getElementById("timeslot").value.trim();
      const room       = document.getElementById("room").value.trim();

      if (!section_id || !course_id || !faculty_id || !timeslot_id || !room) {
        showToast("Fill all fields.", "error");
        btn.disabled = false;
        return;
      }

      try {
        const res = await fetch(`${API}/timetable`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ section_id, course_id, faculty_id, timeslot_id, room })
        });

        const out = await res.json();
        if (!res.ok) {
          showToast(out.message || "Failed to add entry", "error");
        } else {
          showToast("✅ Entry added");
          // Sync view selector with chosen section and reload the grid
          document.getElementById("sectionView").value = section_id;
          // Reset only course/faculty/timeslot/room to speed up bulk entry
          document.getElementById("course").value = "";
          document.getElementById("faculty").value = "";
          document.getElementById("timeslot").value = "";
          document.getElementById("room").value = "";
          await loadTimetable();
        }
      } catch (err) {
        console.error(err);
        showToast("Network error while adding entry", "error");
      } finally {
        btn.disabled = false;
      }
    });

    // --- Edit flow ---
    function openEdit(id, courseId, facultyId, timeslotId, roomEnc="") {
      document.getElementById("editId").value = id;

      const cSelect = document.getElementById("editCourse");
      cSelect.innerHTML = "<option value=''>Select Course</option>";
      courses.forEach(c => cSelect.insertAdjacentHTML("beforeend",
        `<option value="${c.id}" ${c.id==courseId?"selected":""}>${c.code} - ${c.name}</option>`));

      const fSelect = document.getElementById("editFaculty");
      fSelect.innerHTML = "<option value=''>Select Faculty</option>";
      faculty.forEach(f => fSelect.insertAdjacentHTML("beforeend",
        `<option value="${f.id}" ${f.id==facultyId?"selected":""}>${f.name}</option>`));

      const tSelect = document.getElementById("editTimeslot");
      tSelect.innerHTML = "<option value=''>Select Timeslot</option>";
      timeslots.forEach(t => tSelect.insertAdjacentHTML("beforeend",
        `<option value="${t.id}" ${t.id==timeslotId?"selected":""}>${t.day} S${t.session} (${t.start_time}-${t.end_time})</option>`));

      document.getElementById("editRoom").value = decodeURIComponent(roomEnc || "");
      document.getElementById("editModal").style.display = "flex";
    }

    document.getElementById("editForm").addEventListener("submit", async e => {
      e.preventDefault();
      const id = document.getElementById("editId").value;
      const payload = {
        course_id: document.getElementById("editCourse").value,
        faculty_id: document.getElementById("editFaculty").value,
        timeslot_id: document.getElementById("editTimeslot").value,
        room: document.getElementById("editRoom").value.trim()
      };
      try {
        const res = await fetch(`${API}/timetable/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const out = await res.json();
        if (!res.ok) {
          showToast(out.message || "Failed to update entry", "error");
          return;
        }
        showToast("✅ Entry updated");
        document.getElementById("editModal").style.display = "none";
        await loadTimetable();
      } catch {
        showToast("Network error while updating", "error");
      }
    });

    async function deleteEntry(id) {
      if (!confirm("Delete this entry?")) return;
      try {
        const res = await fetch(`${API}/timetable/${id}`, { method: "DELETE" });
        const out = await res.json();
        if (!res.ok) {
          showToast(out.message || "Failed to delete entry", "error");
          return;
        }
        showToast("✅ Entry deleted");
        await loadTimetable();
      } catch {
        showToast("Network error while deleting", "error");
      }
    }

    window.onclick = e => {
      const modal = document.getElementById("editModal");
      if (e.target == modal) modal.style.display = "none";
    };

    function logout() {
      localStorage.removeItem("deanId");
      window.location.href = "login.html";
    }

    // Init
    loadDropdowns();
  </script>
</body>
</html>
