<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Attendance - AU ERP</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <style>
    :root {--primary:#1e293b;--accent:#2563eb;--bg:#f9fafb;--border:#e5e7eb;--text:#1f2937;--hover:#f3f4f6;}
    * {margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}
    body {display:flex;min-height:100vh;background:var(--bg);color:var(--text)}

    /* Sidebar */
    .sidebar {width:240px;background:linear-gradient(180deg,#1e293b,#111827);color:#fff;height:100vh;position:fixed;display:flex;flex-direction:column;box-shadow:2px 0 8px rgba(0,0,0,0.2)}
    .sidebar-header {background:var(--accent);padding:16px;text-align:center;font-size:18px;font-weight:700;letter-spacing:0.5px}
    .student-info {text-align:center;padding:20px 15px;border-bottom:1px solid rgba(255,255,255,0.08)}
    .student-info img {width:70px;height:70px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;margin-bottom:10px;background:#fff}
    .student-info .name {font-size:15px;font-weight:600;margin-bottom:2px}
    .student-info .email,.student-info .role {font-size:12px;color:#9ca3af}
    .sidebar ul {list-style:none;margin:20px 0;padding:0;flex-grow:1}
    .sidebar li {margin:4px 12px}
    .sidebar li a {display:flex;align-items:center;padding:10px 12px;text-decoration:none;color:#d1d5db;font-size:14px;border-radius:6px;transition:all 0.25s ease}
    .sidebar li a i {width:22px;margin-right:10px;font-size:15px}
    .sidebar li a:hover {background:rgba(37,99,235,0.15);color:#fff}
    .sidebar li.active a {background:var(--accent);color:#fff;font-weight:600}
    .sidebar ul li:last-child {margin-top:auto;margin-bottom:20px}

    /* Main */
    .main-content {margin-left:240px;padding:24px;width:calc(100% - 240px);display:flex;flex-direction:column;min-height:100vh}
    .topbar {display:flex;justify-content:space-between;align-items:center;background:#fff;padding:14px 18px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:24px}
    .topbar-left {display:flex;align-items:center;gap:12px}
    .topbar-left img {height:40px}
    .topbar h1 {font-size:20px;font-weight:600;color:var(--primary)}
    .welcome {font-size:14px;text-align:right;color:var(--text)}
    .welcome strong {color:var(--accent)}
    .welcome .email {font-size:12px;color:#6b7280;display:block}

    /* Profile Card */
    .profile-card {background:#fff;padding:22px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;align-items:center;gap:20px;margin-bottom:24px}
    .profile-card img {width:100px;height:100px;border-radius:50%;border:3px solid var(--accent);object-fit:cover}
    .profile-details h2 {font-size:18px;font-weight:700;color:var(--primary);margin:0}
    .profile-details p {font-size:14px;color:#374151;margin:4px 0}
    .profile-details .program {font-size:13px;color:#6b7280}

    /* Section */
    .section {background:#fff;padding:22px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);flex-grow:1}
    .section h2 {font-size:18px;font-weight:600;margin-bottom:18px}

    /* Attendance Content */
    .summary {display:flex;justify-content:space-around;flex-wrap:wrap;margin-bottom:20px}
    .card {flex:1;min-width:180px;margin:10px;padding:20px;background:#f3f4f6;border-radius:8px;text-align:center}
    .card h2 {font-size:18px;margin-bottom:8px}
    .card p {font-size:16px;color:#374151}
    .charts {display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px}
    .chart-box {flex:1;min-width:300px;background:#f9fafb;border-radius:8px;padding:20px}
    table {width:100%;border-collapse:collapse;margin-top:20px}
    th,td {border:1px solid #e5e7eb;padding:10px;text-align:center;font-size:14px}
    th {background:#f3f4f6}
    .present {color:green;font-weight:600}
    .absent {color:red;font-weight:600}

    footer {text-align:center;font-size:12px;color:#6b7280;padding:16px 0;margin-top:auto}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">AU ERP</div>
    <div class="student-info">
      <img id="studentPhotoSide" src="https://i.postimg.cc/fbVwm1L2/Bon.jpg" alt="Student">
      <div class="name" id="studentNameSide">Student</div>
      <div class="email" id="studentEmailSide">student@ced.alliance.edu.in</div>
      <div class="role">University Student</div>
    </div>
    <ul>
      <li><a href="studentdashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
      <li><a href="studenttimetable.html"><i class="fas fa-calendar-alt"></i> Timetable</a></li>
      <li class="active"><a href="studentattendance.html"><i class="fas fa-check-circle"></i> Attendance</a></li>
      <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="topbar">
      <div class="topbar-left">
        <img src="https://i.postimg.cc/cHN88t2D/AU.png" alt="AU Logo">
        <h1>Student Attendance</h1>
      </div>
      <div class="welcome">
        <span>Welcome, <strong id="welcomeName">Student</strong></span>
        <span class="email" id="welcomeEmail">student@ced.alliance.edu.in</span>
      </div>
    </div>

    <!-- Profile Card -->
    <div class="profile-card">
      <img id="profilePhoto" src="https://i.postimg.cc/fbVwm1L2/Bon.jpg" alt="Profile">
      <div class="profile-details">
        <h2 id="profileName">Student Name</h2>
        <p id="profileEmail">student@ced.alliance.edu.in</p>
        <p class="program" id="profileProgram">Program Info</p>
      </div>
    </div>

    <div class="section">
      <h2>Attendance Overview</h2>
      <!-- Summary Cards -->
      <div class="summary">
        <div class="card"><h2>Total Sessions</h2><p id="totalSessions">0</p></div>
        <div class="card"><h2>Present</h2><p id="presentSessions">0</p></div>
        <div class="card"><h2>Absent</h2><p id="absentSessions">0</p></div>
        <div class="card"><h2>Percentage</h2><p id="attendancePercent">0%</p></div>
      </div>

      <!-- Charts -->
      <div class="charts">
        <div class="chart-box">
          <h3>Weekly Attendance</h3>
          <canvas id="weeklyChart"></canvas>
        </div>
        <div class="chart-box">
          <h3>Monthly Attendance</h3>
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>

      <!-- Detailed Table -->
      <h3>ðŸ“… Detailed Attendance</h3>
      <table>
        <thead>
          <tr><th>Date</th><th>Course</th><th>Session</th><th>Status</th></tr>
        </thead>
        <tbody id="attendanceTable"></tbody>
      </table>
    </div>

    <footer>Â© 2025 Alliance University. All rights reserved.</footer>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const studentId = localStorage.getItem("studentId");
      if (!studentId) {
        alert("Not logged in. Redirecting...");
        window.location.href = "index.html";
        return;
      }

      try {
        // ðŸ”¹ Fetch student profile from backend
        const profileRes = await fetch(`/api/student/${studentId}/profile`);
        const profile = await profileRes.json();

        // Fill profile in sidebar + topbar + profile card
        document.getElementById("studentNameSide").textContent = profile.name;
        document.getElementById("welcomeName").textContent = profile.name;
        document.getElementById("studentEmailSide").textContent = profile.email;
        document.getElementById("welcomeEmail").textContent = profile.email;

        document.getElementById("studentPhotoSide").src = profile.photo || "https://i.postimg.cc/fbVwm1L2/Bon.jpg";
        document.getElementById("profilePhoto").src = profile.photo || "https://i.postimg.cc/fbVwm1L2/Bon.jpg";
        document.getElementById("profileName").textContent = profile.name;
        document.getElementById("profileEmail").textContent = profile.email;
        document.getElementById("profileProgram").textContent =
          `${profile.semester ? "Semester " + profile.semester : ""} ${profile.department_name || ""} ${profile.section_name || ""}`;

        // ðŸ”¹ Fetch attendance summary
        const summaryRes = await fetch(`/api/student/${studentId}/attendance/summary`);
        const summary = await summaryRes.json();

        document.getElementById("totalSessions").textContent = summary.totalSessions;
        document.getElementById("presentSessions").textContent = summary.present;
        document.getElementById("absentSessions").textContent = summary.absent;
        document.getElementById("attendancePercent").textContent = summary.percentage + "%";

        // ðŸ”¹ Fetch detailed attendance
        const detailRes = await fetch(`/api/student/${studentId}/attendance`);
        const details = await detailRes.json();

        const tbody = document.getElementById("attendanceTable");
        tbody.innerHTML = "";
        details.forEach(d => {
          tbody.innerHTML += `
            <tr>
              <td>${d.date}</td>
              <td>${d.course}</td>
              <td>${d.session}</td>
              <td class="${d.status === "Present" ? "present" : "absent"}">${d.status}</td>
            </tr>
          `;
        });

        // ðŸ”¹ Weekly chart
        const weeklyData = [
          details.filter(d => d.status === "Present").length,
          details.filter(d => d.status === "Absent").length
        ];
        new Chart(document.getElementById("weeklyChart"), {
          type: "doughnut",
          data: {
            labels: ["Present", "Absent"],
            datasets: [{ data: weeklyData, backgroundColor: ["#16a34a", "#dc2626"] }]
          }
        });

        // ðŸ”¹ Monthly chart
        const monthlyData = {};
        details.forEach(d => {
          const month = new Date(d.date).toLocaleString("default", { month: "short" });
          if (!monthlyData[month]) monthlyData[month] = { present: 0, absent: 0 };
          if (d.status === "Present") monthlyData[month].present++;
          else monthlyData[month].absent++;
        });

        new Chart(document.getElementById("monthlyChart"), {
          type: "bar",
          data: {
            labels: Object.keys(monthlyData),
            datasets: [
              { label: "Present", data: Object.values(monthlyData).map(m => m.present), backgroundColor: "#16a34a" },
              { label: "Absent", data: Object.values(monthlyData).map(m => m.absent), backgroundColor: "#dc2626" }
            ]
          },
          options: { responsive: true, plugins: { legend: { position: "bottom" } } }
        });

      } catch (err) {
        console.error("Error loading attendance:", err);
      }
    });

    function logout() {
      if (confirm("Log out?")) {
        localStorage.clear();
        window.location.href = "index.html";
      }
    }
  </script>
</body>
</html>
