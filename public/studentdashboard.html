<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Dashboard - AU ERP</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <style>
    :root {--primary:#1e293b;--accent:#2563eb;--bg:#f9fafb;--border:#e5e7eb;--text:#1f2937;--hover:#f3f4f6}
    * {margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}
    body {display:flex;min-height:100vh;background:var(--bg);color:var(--text)}

    /* Sidebar */
    .sidebar {width:250px;background:linear-gradient(180deg,#1e293b,#111827);color:#fff;height:100vh;position:fixed;display:flex;flex-direction:column;box-shadow:2px 0 10px rgba(0,0,0,0.15)}
    .sidebar-header {background:#2563eb;padding:18px;text-align:center;font-size:18px;font-weight:700}
    .student-info {text-align:center;padding:20px 15px;border-bottom:1px solid rgba(255,255,255,0.1)}
    .student-info img {width:70px;height:70px;border-radius:50%;border:3px solid #2563eb;object-fit:cover;margin-bottom:10px;background:#fff}
    .student-info .name {font-size:15px;font-weight:600;margin-bottom:4px}
    .student-info .email {font-size:12px;color:#d1d5db}
    .student-info .role {font-size:12px;color:#9ca3af}
    .sidebar ul {list-style:none;margin-top:20px;padding:0 10px;flex-grow:1}
    .sidebar li {margin:6px 0}
    .sidebar li a {display:flex;align-items:center;padding:12px 14px;text-decoration:none;color:#d1d5db;font-size:14px;border-radius:8px;transition:all 0.3s ease}
    .sidebar li a i {width:22px;margin-right:10px}
    .sidebar li a:hover {background:rgba(37,99,235,0.15);color:#fff}
    .sidebar li.active a {background:#2563eb;color:#fff;font-weight:600}
    .sidebar ul li:last-child {margin-top:auto;margin-bottom:20px}

    /* Main */
    .main-content {margin-left:250px;padding:24px;width:calc(100% - 250px);display:flex;flex-direction:column;min-height:100vh}
    .topbar {display:flex;justify-content:space-between;align-items:center;background:#fff;padding:14px 18px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:24px}
    .topbar-left {display:flex;align-items:center;gap:12px}
    .topbar-left img {height:40px}
    .topbar h1 {font-size:20px;font-weight:600;color:var(--primary)}
    .welcome {font-size:14px;text-align:right;color:var(--text)}
    .welcome strong {color:var(--accent)}
    .welcome .email {font-size:12px;color:#6b7280;display:block}

    /* Layout */
    .content-grid {display:grid;grid-template-columns:1fr 2fr;gap:24px;flex-grow:1}
    .card {background:#fff;padding:20px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .card h2 {font-size:18px;font-weight:600;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:8px}

    /* Profile Card (redesigned like ERP) */
    .profile-card {text-align:center;padding:24px}
    .profile-card img {width:120px;height:120px;border-radius:50%;border:4px solid var(--accent);object-fit:cover;margin-bottom:12px;background:#fff}
    .profile-card h2 {font-size:20px;font-weight:700;color:var(--primary);margin-bottom:4px}
    .profile-card p {font-size:14px;color:#374151;margin-bottom:16px}
    .profile-details {font-size:14px;line-height:1.6;text-align:left;max-width:520px;margin:0 auto 16px}
    .profile-row {display:flex;gap:8px;align-items:flex-start;margin-bottom:6px}
    .profile-details b {display:inline-block;min-width:160px;color:#374151}
    .profile-details .value {flex:1;word-break:break-word}
    .profile-footer button {background:#16a34a;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600}
    .profile-footer button:hover {background:#15803d}

    /* Timetable */
    .timetable-table {width:100%;border-collapse:collapse;font-size:14px}
    .timetable-table th, .timetable-table td {border:1px solid var(--border);padding:10px;text-align:center}
    .timetable-table th {background:#f3f4f6}
    footer {text-align:center;font-size:12px;color:#6b7280;padding:16px 0;margin-top:auto}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">AU ERP</div>
    <div class="student-info">
      <img id="studentPhoto" src="https://i.postimg.cc/fbVwm1L2/Bon.jpg" alt="Student">
      <div class="name" id="studentName">Student</div>
      <div class="email" id="studentEmail">student@ced.alliance.edu.in</div>
      <div class="role">University Student</div>
    </div>
    <ul>
      <li class="active"><a href="studentdashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
      <li><a href="studenttimetable.html"><i class="fas fa-calendar-alt"></i> Timetable</a></li>
      <li><a href="studentattendance.html"><i class="fas fa-check-circle"></i> Attendance</a></li>
      <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="topbar">
      <div class="topbar-left">
        <img src="https://i.postimg.cc/cHN88t2D/AU.png" alt="AU Logo">
        <h1>Student Dashboard</h1>
      </div>
      <div class="welcome">
        <span>Welcome, <strong id="welcomeName">Student</strong></span>
        <span class="email" id="welcomeEmail">student@ced.alliance.edu.in</span>
      </div>
    </div>

    <div class="content-grid">
      <!-- Profile Card -->
      <div class="card profile-card">
        <img id="profilePhoto" src="https://i.postimg.cc/fbVwm1L2/Bon.jpg" alt="Profile Photo">
        <h2 id="profileName">Student Name</h2>
        <p id="profileProgram">Program Info</p>

        <div class="profile-details" id="profileDetails"></div>

        <div class="profile-footer">
          <button onclick="window.location.href='profile.html'">Update Profile</button>
        </div>
      </div>

      <!-- Today’s Timetable -->
      <div class="card">
        <h2>Today's Timetable</h2>
        <table class="timetable-table" id="todayTimetable">
          <thead>
            <tr><th>Session</th><th>Course</th><th>Faculty</th><th>Room</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <footer>© 2025 Alliance University. All rights reserved.</footer>
  </div>

<script>
  const studentId = localStorage.getItem("studentId");

  // Format as DD/MM/YYYY
  function formatDOB(d) {
    if (!d) return "N/A";
    try {
      const date = new Date(d);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    } catch {
      return "N/A";
    }
  }

  if (!studentId) {
    alert("Not logged in. Redirecting...");
    window.location.href = "index.html";
  } else {
    // Profile
    fetch(`/api/student/${studentId}/profile`)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          document.getElementById("profileDetails").innerHTML = `<p>${data.error}</p>`;
          return;
        }
        // Sidebar + Topbar
        document.getElementById("studentName").textContent = data.name;
        document.getElementById("studentEmail").textContent = data.email;
        document.getElementById("welcomeName").textContent = data.name;
        document.getElementById("welcomeEmail").textContent = data.email;
        document.getElementById("studentPhoto").src = data.photo || "https://i.postimg.cc/fbVwm1L2/Bon.jpg";

        // Profile card
        document.getElementById("profilePhoto").src = data.photo || "https://i.postimg.cc/fbVwm1L2/Bon.jpg";
        document.getElementById("profileName").textContent = data.name;
        document.getElementById("profileProgram").textContent =
          `${data.semester ? "Semester " + data.semester : ""} ${data.department_name || ""} ${data.section_name || ""}`.trim();

        // Details
        const rows = [
          ["Date of Birth:", formatDOB(data.dob)],
          ["Mobile No:", data.mobile || "N/A"],
          ["Registration No:", data.registration_no || "N/A"],
          ["University Email:", data.email || "N/A"],
          ["Alternate Email:", data.alt_email || "N/A"],
          ["Department:", `${data.department_name || "N/A"}${data.department_code ? " ("+data.department_code+")" : ""}`],
          ["Batch:", `${data.start_year || ""} - ${data.end_year || ""}`.trim()],
          ["Section:", data.section_name || "N/A"],
          ["Semester:", data.semester ?? "N/A"],
          ["Status:", data.is_active ? "Active" : "Inactive"],
        ];

        document.getElementById("profileDetails").innerHTML =
          rows.map(([label, value]) => `
            <div class="profile-row">
              <b>${label}</b>
              <span class="value">${value}</span>
            </div>
          `).join("");
      });

    // Today’s timetable
    const todayIndex = new Date().getDay();
    fetch(`/api/student/${studentId}/timetable`)
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector("#todayTimetable tbody");
        const todayClasses = Array.isArray(data) ? data.filter(row => row.daysOfWeek?.includes(todayIndex)) : [];
        if (todayClasses.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4">No classes today</td></tr>`;
          return;
        }
        tbody.innerHTML = todayClasses.map(row => `
          <tr>
            <td>${row.startTime} - ${row.endTime}</td>
            <td>${row.title}</td>
            <td>${row.extendedProps?.faculty || ""}</td>
            <td>${row.extendedProps?.room || ""}</td>
          </tr>
        `).join("");
      })
      .catch(() => {
        document.querySelector("#todayTimetable tbody").innerHTML = `<tr><td colspan="4">Error loading timetable</td></tr>`;
      });
  }

  function logout() {
    if (confirm("Log out?")) {
      localStorage.clear();
      window.location.href = "index.html";
    }
  }
</script>
</body>
</html>
